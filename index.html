<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Okta Widget Force-Redirect Debug (fixed)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://global.oktacdn.com/okta-signin-widget/7.35.3/css/okta-sign-in.min.css" rel="stylesheet" />
  <link href="https://global.oktacdn.com/okta-signin-widget/7.35.3/css/okta-theme.css" rel="stylesheet" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:24px}
    #widget-wrap{max-width:480px;margin:32px auto}
    #status{margin-bottom:12px;color:#333}
    pre.debug{background:#f6f8fa;padding:8px;border-radius:6px;overflow:auto;max-height:220px}
    .error{color:#b00020}
  </style>
</head>
<body>
  <div id="widget-wrap">
    <div id="status">Initializing widget…</div>
    <div id="widget-container">Loading widget…</div>
    <div id="errors"></div>
    <h4>Debug</h4>
    <pre id="log" class="debug"></pre>
  </div>

  <!-- Okta Auth JS for callback (loaded separately) -->
  <script src="https://cdn.jsdelivr.net/npm/@okta/okta-auth-js@7.8.0/dist/okta-auth-js.min.js"></script>

  <script>
    // --------- Configuration (edit these) ----------
    const OKTA_DOMAIN = 'trial-4702613.okta.com';     // your Okta domain
    const CLIENT_ID = '0oawflwp5euQKcPIN697';         // your client id
    const REDIRECT_URI = 'https://custom-spa-okta.vercel.app/callback.html'; // exact redirect uri in Okta
    // ------------------------------------------------

    const logEl = document.getElementById('log');
    function dbg(msg, obj) {
      logEl.textContent += new Date().toISOString() + ' - ' + msg + (obj ? ' ' + JSON.stringify(obj, null, 2) : '') + '\n';
      console.log(msg, obj || '');
    }
    function showError(text) {
      document.getElementById('errors').innerHTML = '<div class="error">' + text + '</div>';
      dbg('ERROR: ' + text);
    }

    // Define initWidget on window so the dynamically-added script can call it safely
    window.initWidget = function() {
      if (typeof OktaSignIn === 'undefined') {
        showError('OktaSignIn global missing after CDN load. Check network/CSP.');
        return;
      }
      dbg('OktaSignIn loaded (fresh).');

      const widget = new OktaSignIn({
        baseUrl: `https://${OKTA_DOMAIN}`,
        clientId: CLIENT_ID,
        redirectUri: REDIRECT_URI,
        useClassicEngine: true,
        authParams: {
          issuer: `https://${OKTA_DOMAIN}/oauth2/default`,
          responseType: ['code'],
          responseMode: 'query',      // FORCE redirect with code in query string
          display: 'page',
          scopes: ['openid','profile','email'],
          pkce: true
        }
      });

      if (widget.settings && widget.settings.authParams) {
        dbg('Widget authParams:', widget.settings.authParams);
      }

      // Optional: try to capture the authorize URL if widget exposes it
      const origGetAuthorizeUrl = widget.getAuthorizeUrl && widget.getAuthorizeUrl.bind(widget);
      if (origGetAuthorizeUrl) {
        widget.getAuthorizeUrl = function() {
          try {
            const url = origGetAuthorizeUrl();
            dbg('Authorize URL about to be used:', url);
            return url;
          } catch (e) {
            dbg('Error while getting authorize URL', e.message);
            return origGetAuthorizeUrl();
          }
        };
      } else {
        dbg('widget.getAuthorizeUrl not present (will inspect network).');
      }

      widget.renderEl(
        { el: '#widget-container' },
        function(res) {
          dbg('widget.renderEl success', res);
          document.getElementById('status').innerText = 'Widget loaded — sign in form visible.';
        },
        function(err) {
          console.error('widget render error', err);
          showError('Widget render error — see console and debug log.');
          dbg('widget render error object', err);
          document.getElementById('status').innerText = 'Widget error — see debug info.';
        }
      );
      dbg('Widget init complete. Try signing in now.');
    };

    // Now inject the widget script with a cache-busting query param
    (function injectWidgetScript() {
      const t = Date.now();
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/@okta/okta-signin-widget@7.35.3/dist/js/okta-sign-in.min.js?_=' + t;
      script.onload = function() {
        // call the init function we already defined on window
        if (typeof window.initWidget === 'function') {
          window.initWidget();
        } else {
          showError('initWidget not defined after widget script loaded.');
        }
      };
      script.onerror = function() {
        showError('Failed to load widget script. Check network/CSP.');
        console.error('Failed to load okta-sign-in.min.js');
      };
      document.head.appendChild(script);
    })();
  </script>
</body>
</html>
